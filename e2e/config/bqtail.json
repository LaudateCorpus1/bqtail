{
  "RunOnce": true,
  "BatchURL": "gs://e2e-data/batch/",
  "DeferTaskURL": "gs://e2e-data/tasks/",
  "ErrorURL": "gs://e2e-data/errors/",
  "JournalURL": "gs://e2e-data/journal/",

  "Rules": [
    {
      "When": {
        "Prefix": "/data/case001",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy"
      }
    },
    {
      "When": {
        "Prefix": "/data/case002",
        "Suffix": ".json"
      },
      "Async": true,
      "Dest": {
        "Table": "bqtail.dummy"
      },
      "OnSuccess": [
        {
          "Action": "delete"
        }
      ]
    },
    {
      "When": {
        "Prefix": "/data/case003",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy"
      },
      "Batch": {
        "Window": {
          "DurationInSec": 10
        }
      },
      "OnSuccess": [
        {
          "Action": "delete"
        }
      ]
    },
    {
      "When": {
        "Prefix": "/data/case004",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy"
      },
      "Batch": {
        "Window": {
          "DurationInSec": 10
        }
      },
      "Async": true,
      "OnSuccess": [
        {
          "Action": "delete"
        }
      ],
      "OnFailure": [
        {
          "Action": "move",
          "Request": {
            "DestURL": "gs://e2e-data/errors"
          }
        }
      ]
    },
    {
      "When": {
        "Prefix": "/data/case005",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy",
        "TransientDataset": "temp"
      },
      "OnSuccess": [
        {
          "Action": "delete"
        }
      ]
    },
    {
      "When": {
        "Prefix": "/data/case006",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy",
        "TransientDataset": "temp",
        "UniqueColumns": [
          "id"
        ]
      },
      "OnSuccess": [
        {
          "Action": "delete"
        }
      ],
      "Batch": {
        "Window": {
          "DurationInSec": 15
        }
      },
      "Async": true
    },
    {
      "When": {
        "Prefix": "/data/case007",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy",
        "TransientDataset": "temp",
        "UniqueColumns": [
          "id"
        ]
      },
      "OnSuccess": [
        {
          "Action": "delete"
        }
      ],
      "Batch": {
        "Window": {
          "DurationInSec": 15
        }
      }
    },
    {
      "When": {
        "Prefix": "/data/case010",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.dummy",
        "TransientDataset": "temp",
        "UniqueColumns": ["id"]
      },
      "Batch": {
        "Window": {
          "DurationInSec": 15
        }
      },
      "OnSuccess": [
        {
          "Action": "delete"
        },
        {
          "Action": "query",
          "Request": {
            "SQL": "SELECT '$JobID' AS job_id, COUNT(1) AS row_count, CURRENT_TIMESTAMP() AS completed FROM $DestTable",
            "Dest": "bqtail.summary"
          }
        }
      ]
    },
    {
      "When": {
        "Prefix": "/data/case011",
        "Suffix": ".json"
      },
      "Async": true,
      "Dest": {
        "Table": "bqtail.dummy",
        "TransientDataset": "temp",
        "UniqueColumns": ["id"]
      },
      "Batch": {
        "Window": {
          "DurationInSec": 15
        }
      },
      "OnSuccess": [
        {
          "Action": "delete"
        },
        {
          "Action": "query",
          "Request": {
            "SQL": "SELECT '$JobID' AS job_id, COUNT(1) AS row_count, CURRENT_TIMESTAMP() AS completed FROM $DestTable",
            "Dest": "bqtail.summary"
          }
        }
      ]
    },
    {
      "When": {
        "Prefix": "/data/case012",
        "Suffix": ".json"
      },
      "Dest": {
        "Table": "bqtail.wrong_dummy"
      },
      "OnFailure": [
        {
          "Action": "notify",
          "Request": {
            "Channels": [
              "#e2e"
            ],
            "From": "BqTail",
            "Title": "bqtail.wrong_dummy ingestion",
            "Message": "$Error",
            "Secret": {
              "URL": "gs://${config.Bucket}/config/slack.json.enc",
              "Key": "BqTailRing/BqTailKey"
            }
          }
        }
      ]
    }
  ]
}